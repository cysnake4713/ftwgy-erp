<?xml version="1.0" encoding="UTF-8"?>
<openerp>
    <data>
        <record id="view_doc_transform_tree" model="ir.ui.view">
            <field name="name">view.ft.document.transform.tree</field>
            <field name="model">ft.document.transform</field>
            <field name="arch" type="xml">
                <tree colors="grey:state == 'finish';green:state == 'draft'">
                    <field name="code"/>
                    <field name="name"/>
                    <field name="from_unit"/>
                    <field name="receive_date"/>
                    <field name="urgency"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

        <record id="view_doc_transform_search" model="ir.ui.view">
            <field name="name">view.ft.document.transform.search</field>
            <field name="model">ft.document.transform</field>
            <field name="arch" type="xml">
                <search>
                    <field name="code"/>
                    <field name="name"/>
                    <field name="from_unit"/>
                    <field name="receive_date"/>
                    <field name="urgency"/>
                    <field name="state"/>
                    <group string="分组">
                        <filter string="状态" icon="terp-folder-orange" context="{'group_by':'state'}"/>
                        <filter string="待校长审批" icon="terp-folder-orange" domain="[('state','=','principal')]"
                                groups="ft_doc_transform.group_doc_trans_principal"/>
                        <filter string="待副校长审批" icon="terp-folder-orange" domain="[('state','=','vice_principal')]"
                                groups="ft_doc_transform.group_doc_trans_vice_principal"/>
                        <filter string="待部门领导审批" icon="terp-folder-orange" domain="[('state','=','department')]"
                                groups="ft_doc_transform.group_doc_trans_department"/>
                    </group>
                </search>
            </field>
        </record>

        <record id="view_doc_transform_form" model="ir.ui.view">
            <field name="name">view.ft.document.transform.form</field>
            <field name="model">ft.document.transform</field>
            <field name="arch" type="xml">
                <form class="float_header">
                    <header>
                        <button name="button_draft" string="提交" type="object" class="oe_highlight" states="draft"
                                groups="ft_doc_transform.group_doc_trans_user"
                                context="{
                                'state': 'principal',
                                'message_users': [request_principal_user],
                                'message': '需要您的批示',
                                'wechat_code': [%(ft_doc_transform.map_ft_doc_transform)d],
                                'wechat_template': %(ft_doc_transform.message_template_doc_transform)d,
                                }"/>
                        <button name="common_reject" string="撤销到草稿" type="object" class="oe_highlight" states="principal,vice_principal"
                                groups="ft_doc_transform.group_doc_trans_user" is_reject="1"
                                context="{
                                'state': 'draft',
                                'clear':['request_principal_vice_principals','request_department_users',
                                'request_department_teacher_users','principal_comment',
                                'request_vice_department_teacher_users','request_vice_department_users','vice_principal_comment'],
                                }"/>
                        <button name="principal_apply" string="提交" type="object" class="oe_highlight"
                                states_editable="{'principal':{'users':[request_principal_user]}}"
                                context="{
                                'state': 'finish_teacher',
                                'message_users': [request_department_users,request_department_teacher_users],
                                'message': '需要您的查看',
                                'wechat_code': [%(ft_doc_transform.map_ft_doc_transform)d],
                                'wechat_template': %(ft_doc_transform.message_template_doc_transform)d,
                                }"/>
                        <button name="common_reject" string="打回" type="object" is_log="1"
                                states_editable="{'principal':{'users':[request_principal_user]}}"
                                context="{
                                'state': 'draft',
                                'message_users': [draft_user],
                                'message': '您的请求被打回,请处理',
                                'wechat_code': [%(ft_doc_transform.map_ft_doc_transform)d],
                                'wechat_template': %(ft_doc_transform.message_template_doc_transform)d,
                                'clear':['request_principal_vice_principals','request_department_users',
                                'request_department_teacher_users','principal_comment'],
                                }" is_reject="1"/>

                        <button name="vice_principal_apply" string="提交" type="object" class="oe_highlight"
                                states_editable="{'vice_principal':{'users':[request_principal_user,request_principal_vice_principals]}}"
                                context="{
                                'state': 'department',
                                'message_users': [request_vice_department_users,request_vice_department_teacher_users],
                                'message': '需要您的查看',
                                'wechat_code': [%(ft_doc_transform.map_ft_doc_transform)d],
                                'wechat_template': %(ft_doc_transform.message_template_doc_transform)d,
                                }"/>
                        <button name="vice_principal_reject" string="打回" type="object" is_log="1"
                                states_editable="{'vice_principal':{'users':[request_principal_user,request_principal_vice_principals]}}"
                                context="{
                                'state': 'draft',
                                'message_users': [draft_user],
                                'message': '您的请求被打回,请处理',
                                'wechat_code': [%(ft_doc_transform.map_ft_doc_transform)d],
                                'wechat_template': %(ft_doc_transform.message_template_doc_transform)d,
                                'clear':['request_vice_department_teacher_users','request_vice_department_users','vice_principal_comment'],
                                }" is_reject="1"/>

                        <button name="button_department_finish" string="提交" type="object" class="oe_highlight"
                                states_editable="{'department':{'users':[request_vice_department_users,request_department_users]}}"
                                context="{
                                'state': 'finish_teacher',
                                'message_users': [department_comment_user],
                                'message': department_comment,
                                'wechat_code': [%(ft_doc_transform.map_ft_doc_transform)d],
                                'wechat_template': %(ft_doc_transform.message_template_doc_transform)d,
                                }"/>
                        <button name="common_reject" string="打回" type="object" is_reject="1" is_log="1"
                                states_editable="{'department':{'users':[request_vice_department_users,request_department_users]}}"
                                context="{
                                'state': 'principal',
                                'message_users': [request_principal_user],
                                'message': '您的请求被打回,请处理',
                                'wechat_code': [%(ft_doc_transform.map_ft_doc_transform)d],
                                'wechat_template': %(ft_doc_transform.message_template_doc_transform)d,
                                'clear':['department_comment','department_comment_user'],
                                }"/>

                        <!--<button name="common_reject" string="撤销" type="object" is_log="1"-->
                        <!--states_editable="{'finish':{'users':[request_vice_department_users,request_department_users]}}"-->
                        <!--context="{'state':'department'}" is_reject="1"/>-->
                        <button name="button_teacher_finish" string="已完成" class="oe_highlight" type="object" states="finish_teacher"
                                is_wechat="1" prompt="处理结果"/>
                        <field name="state" widget="statusbar" readonly="1"
                               statusbar_visible="draft,principal,vice_principal,department,finish_teacher,finish"/>
                    </header>
                    <sheet>
                        <group string="草稿">
                            <field name="name" states_editable="{'draft':{'groups':%(ft_doc_transform.group_doc_trans_user)d}}"/>
                            <group colspan="2" col="4">
                                <field name="from_unit" states_editable="{'draft':{'groups':%(ft_doc_transform.group_doc_trans_user)d}}"/>
                                <field name="code" states_editable="{'draft':{'groups':%(ft_doc_transform.group_doc_trans_user)d}}"/>
                                <field name="receive_date" states_editable="{'draft':{'groups':%(ft_doc_transform.group_doc_trans_user)d}}"/>
                                <field name="urgency" states_editable="{'draft':{'groups':%(ft_doc_transform.group_doc_trans_user)d}}"/>
                            </group>
                            <field name="attachments" widget="many2many_binary"
                                   states_editable="{'draft':{'groups':[%(ft_doc_transform.group_doc_trans_user)d]}}"/>
                            <group colspan="2" string="备注">
                                <field name="comment" nolabel="1" colspan="2"
                                       states_editable="{'draft':{'groups':[%(ft_doc_transform.group_doc_trans_user)d]}}"/>
                            </group>
                            <field name="request_principal_user" required="1"
                                   domain="['|',('groups_id','=',%(ft_doc_transform.group_doc_trans_principal)d),('groups_id','=',%(ft_doc_transform.group_doc_trans_vice_principal)d)]"
                                   states_editable="{'draft':{'groups':[%(ft_doc_transform.group_doc_trans_user)d]}}"/>
                            <group colspan="2" col="4">
                                <field name="draft_user" readonly="1"/>
                                <field name="draft_datetime" readonly="1"/>
                            </group>
                        </group>
                        <group string="校长批示" states="principal,vice_principal,department,finish,finish_teacher">
                            <field name="principal_apply_type" widget="radio" required="1" class="oe_edit_only"
                                   states_editable="{'principal':{'users':[request_principal_user]}}"/>
                            <field name="request_principal_vice_principals" widget="many2many_tags"
                                   domain="[('groups_id','=',%(ft_doc_transform.group_doc_trans_vice_principal)d)]"
                                   attrs="{'invisible':[('principal_apply_type','!=','vice_principal')],'required':[('state','=','principal'),('principal_apply_type','=','vice_principal')]}"
                                   states_editable="{'principal':{'users':[request_principal_user]}}"
                                    />
                            <field name="request_department_teacher_users" widget="many2many_tags_multi"
                                   domain="[('groups_id','!=',%(ft_doc_transform.group_doc_trans_department)d)]"
                                   attrs="{'invisible':[('principal_apply_type','!=','teacher')],'required':[('state','=','principal'),('principal_apply_type','=','teacher')]}"
                                   states_editable="{'principal':{'users':[request_principal_user]}}" context="{
                                   'tree_view_ref':'ft_department.view_users_tree',
                                   }"/>
                            <div colspan="2" class="oe_edit_only" attrs="{'invisible':[('principal_apply_type','!=','teacher')]}">
                                <p>如果本公文需要抄送部门经理,请在下方字段填入部门经理姓名</p>
                            </div>
                            <field name="request_department_users" string="抄送部门执行人" widget="many2many_tags"
                                   attrs="{'invisible':[('principal_apply_type','!=','department')],'required':[('state','=','principal'),('principal_apply_type','=','department')]}"
                                   domain="[('groups_id','=',%(ft_doc_transform.group_doc_trans_department)d)]"
                                   states_editable="{'principal':{'users':[request_principal_user]},'department':{'users':[1]}}"/>
                            <field name="principal_comment" states_editable="{'principal':{'users':[request_principal_user]}}"/>
                            <group colspan="2" col="4">
                                <field name="principal_user" readonly="1"/>
                                <field name="principal_datetime" readonly="1"/>
                            </group>
                        </group>

                        <group string="副校长批示" states="vice_principal,department,finish,finish_teacher">
                            <field name="vice_principal_apply_type" widget="radio" required="1" class="oe_edit_only"
                                   states_editable="{'vice_principal':{'users':[request_principal_user,request_principal_vice_principals]}}"/>

                            <field name="request_vice_department_teacher_users" widget="many2many_tags_multi"
                                   attrs="{'invisible':[('vice_principal_apply_type','!=','teacher')],'required':[('state','=','vice_principal'),('vice_principal_apply_type','=','teacher')]}"
                                   states_editable="{'vice_principal':{'users':[request_principal_user,request_principal_vice_principals]}}" context="{
                                   'tree_view_ref':'ft_department.view_users_tree',
                                   }"/>
                            <div colspan="2" class="oe_edit_only" attrs="{'invisible':[('vice_principal_apply_type','!=','teacher')]}">
                                <p>如果本公文需要抄送部门经理,请在下方字段填入部门经理姓名</p>
                            </div>
                            <field name="request_vice_department_users" string="抄送部门执行人" widget="many2many_tags"
                                   attrs="{'invisible':[('vice_principal_apply_type','=','to_end')],'required':[('state','=','vice_principal'),('vice_principal_apply_type','=','department')]}"
                                   domain="[('groups_id','=',%(ft_doc_transform.group_doc_trans_department)d)]"
                                   states_editable="{'vice_principal':{'users':[request_principal_user,request_principal_vice_principals]}}"/>
                            <field name="vice_principal_comment"
                                   states_editable="{'vice_principal':{'users':[request_principal_user,request_principal_vice_principals]}}"/>
                            <group colspan="2" col="4">
                                <field name="vice_principal_user" readonly="1"/>
                                <field name="vice_principal_datetime" readonly="1"/>
                            </group>
                        </group>
                        <group string="部门落实" states="department,finish,finish_teacher">
                            <field name="department_apply_type" widget="radio" required="1" class="oe_edit_only"
                                   states_editable="{'department':{'users':[request_department_users,request_vice_department_users]}}"/>
                            <field name="department_comment_user" widget="many2many_tags_multi"
                                   attrs="{'invisible':[('department_apply_type','=','to_end')],'required':[('state','=','department'),('department_apply_type','=','teacher')]}"
                                   states_editable="{'department':{'users':[request_department_users,request_vice_department_users]}}" context="{
                                   'tree_view_ref':'ft_department.view_users_tree',
                                   }"/>
                            <field name="department_comment"
                                   states_editable="{'department':{'users':[request_department_users,request_vice_department_users]}}"
                                    />
                            <group colspan="2" col="4">
                                <field name="department_user" readonly="1"/>
                                <field name="department_datetime" readonly="1"/>
                            </group>
                        </group>
                        <group string="处理结果"  states="finish,finish_teacher">
                            <field name="results" readonly="1" nolabel="1">
                                <tree>
                                    <field name="user"/>
                                    <field name="state"/>
                                    <field name="finish_date"/>
                                    <field name="comment"/>
                                </tree>
                            </field>
                        </group>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>
    </data>
</openerp>