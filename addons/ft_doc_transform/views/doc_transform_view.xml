<?xml version="1.0" encoding="UTF-8"?>
<openerp>
    <data>
        <record id="view_doc_transform_tree" model="ir.ui.view">
            <field name="name">view.ft.document.transform.tree</field>
            <field name="model">ft.document.transform</field>
            <field name="arch" type="xml">
                <tree colors="grey:state == 'finish'">
                    <field name="name"/>
                    <field name="principal_user"/>
                    <field name="principal_datetime"/>
                    <field name="department_user"/>
                    <field name="department_datetime"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

        <record id="view_doc_transform_form" model="ir.ui.view">
            <field name="name">view.ft.document.transform.form</field>
            <field name="model">ft.document.transform</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <button name="common_apply" string="提交" type="object" class="oe_highlight" states="draft"
                                groups="ft_doc_transform.group_doc_trans_user"
                                context="{'state':'principal',
                                'message_users':[request_principal_user],
                                'message':'需要您的批示',
                                'wechat_code':[%(ft_doc_transform.map_ft_doc_transform)d],
                                }"/>

                        <button name="principal_apply" string="提交" type="object" class="oe_highlight" is_log="1"
                                states_editable="{'principal':{'users':[request_principal_user]}}"
                                context="{'state':'department',
                                'message_users':[request_department_users,request_department_teacher_users],
                                'message':'需要您的查看',
                                }"/>
                        <button name="common_reject" string="打回" type="object" is_log="1"
                                states_editable="{'principal':{'users':[request_principal_user]}}"
                                context="{'state':'draft',
                                'message_users':[draft_user],
                                'message':'您的请求被打回,请处理',
                                }" is_reject="1"/>

                        <button name="common_apply" string="提交" type="object" class="oe_highlight"
                                states_editable="{'department':{'users':[request_department_users]}}"
                                context="{'state':'finish',
                                'message_users':[department_comment_user],
                                'message':department_comment,
                                }"/>
                        <button name="common_reject" string="打回" type="object" is_reject="1" is_log="1"
                                states_editable="{'department':{'users':[request_department_users]}}"
                                context="{'state':'principal',
                                'message_users':[request_principal_user],
                                'message':'您的请求被打回,请处理',
                                }"/>

                        <button name="common_reject" string="撤销" type="object" is_log="1"
                                states_editable="{'finish':{'users':[request_department_users]}}"
                                context="{'state':'department'}" is_reject="1"/>

                        <field name="state" widget="statusbar" readonly="1" statusbar_visible="draft,principal,department,finish"/>
                    </header>
                    <sheet>
                        <group string="草稿">
                            <field name="name" states_editable="{'draft':{'groups':%(ft_doc_transform.group_doc_trans_user)d}}"/>
                            <field name="attachments" widget="many2many_binary"
                                   states_editable="{'draft':{'groups':[%(ft_doc_transform.group_doc_trans_user)d]}}"/>
                            <field name="request_principal_user" required="1"
                                   domain="[('groups_id','=',%(ft_doc_transform.group_doc_trans_principal)d)]"
                                   states_editable="{'draft':{'groups':[%(ft_doc_transform.group_doc_trans_user)d]}}"/>
                            <group colspan="2" col="4">
                                <field name="draft_user" readonly="1"/>
                                <field name="draft_datetime" readonly="1"/>
                            </group>
                        </group>
                        <group string="校领导批示" states="principal,department,finish,finish_teacher">
                            <field name="principal_apply_type" widget="radio" required="1"
                                   states_editable="{'principal':{'users':[request_principal_user]}}"/>

                            <field name="request_department_teacher_users" widget="many2many_tags_multi"
                                   domain="[('groups_id','!=',%(ft_doc_transform.group_doc_trans_department)d)]"
                                   attrs="{'invisible':[('principal_apply_type','=','department')],'required':[('state','=','principal'),('principal_apply_type','=','teacher')]}"
                                   states_editable="{'principal':{'users':[request_principal_user]}}" context="{
                                   'tree_view_ref':'ft_department.view_users_tree',
                                   }"/>

                            <div colspan="2" class="oe_edit_only" attrs="{'invisible':[('principal_apply_type','=','department')]}">
                                <p>如果本公文需要抄送部门经理,请在下方字段填入部门经理姓名</p>
                            </div>
                            <field name="request_department_users" string="抄送部门执行人" widget="many2many_tags"
                                   states_required="department"
                                   domain="[('groups_id','=',%(ft_doc_transform.group_doc_trans_department)d)]"
                                   states_editable="{'principal':{'users':[request_principal_user]},'department':{'users':[1]}}"/>

                            <group colspan="2" col="4">
                                <field name="principal_user" readonly="1"/>
                                <field name="principal_datetime" readonly="1"/>
                            </group>
                        </group>
                        <group string="部门落实" states="department,finish">
                            <field name="department_comment" states_required="department"
                                   states_editable="{'department':{'users':[request_department_users]}}"
                                    />
                            <field name="department_comment_user" states_required="department" widget="many2many_tags_multi"
                                   states_editable="{'department':{'users':[request_department_users]}}" context="{
                                   'tree_view_ref':'ft_department.view_users_tree',
                                   }"/>
                            <group colspan="2" col="4">
                                <field name="department_user" readonly="1"/>
                                <field name="department_datetime" readonly="1"/>
                            </group>
                        </group>
                        <!--<group string="备注">-->
                        <!--<field name="comment" nolabel="1"/>-->
                        <!--</group>-->
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>
    </data>
</openerp>